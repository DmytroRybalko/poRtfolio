---
title: "Lab3b"
output: html_document
---

# Load necessary libraries
```{r}
library(tidyverse)
#library(lubridate)
library(scales)
```
## Load data for Lab3b
```{r}
my_data <- readRDS("data4week3.rds")
```
Add a chart that shows yearly sales by Country. Select a Line chart to display
the yearly trend. Make sure that the Years are located in the X axis,
the Revenue in the Y axis, and the Countries as categories.
## Question 1: Which countryâ€™s trend is the most different when compared to
## the other countries?
```{r}
ans_1 <- my_data %>%
    group_by(Year, Country) %>%
    summarise(Total = sum(Revenue))

ggplot(ans_1, aes(x = Year, y = Total, color = reorder(Country, -Total))) +
    geom_line(size = 1.2) +
    geom_point(size = 2) +
    scale_y_continuous(labels = scales::dollar) +
    labs(x = "Year", y = "Total Revenue", color = "Country",
         title = "Yearly Sales by Country") +
    theme(plot.title = element_text(face = "bold", hjust = 0.5))
```
## Question 2: Which year does the Bikes category have the least sales?
```{r}
ans_2 <- my_data %>%
    group_by(Year, `Product Category`) %>%
    summarise(Total = sum(Revenue))

ggplot(ans_2, aes(x = Year, y = Total, color = reorder(`Product Category`,- Total))) +
    geom_line(size = 1.2) +
    geom_point(size = 2) +
    scale_y_continuous(labels = scales::dollar) +
    labs(x = "Year", y = "Total Revenue", color = " Product\nCategory",
         title = "Yearly Sales by Category") +
    theme(plot.title = element_text(face = "bold", hjust = 0.5))
```
Add another pivot chart, this time for the pivot table that shows Revenue by
Age Group. Select a Pie chart to display the proportion of each Age Group.
Add the Data labels to show percentage, formatted to two decimal points. 
First of all preparing data for visualize:
```{r}
ans_3 <- my_data %>%
    group_by(`Age Group`) %>%
    summarise(Total = sum(Revenue)) %>%
    arrange(Total) %>%
    mutate(Prop = formatC(Total / sum(Total), digits = 4, format = "f") %>%
               as.numeric(),
           Percent = paste(Prop * 100, "%"),
           y_tick = cumsum(Prop) - Prop / 2)

ans_3$`Age Group` <- factor(ans_3$`Age Group`,
                                      levels = ans_3$`Age Group`)
```
In this chart, we can clearly see the proportion of sales for each Age Group
## Question 3: What is the proportion of sales for Young Adults?
```{r}
ggplot(ans_3, aes(x = "", y = Prop, fill = `Age Group`)) +
    geom_bar(width = 1, stat = "identity") +
    coord_polar(theta = "y") +
    labs(title = "Sales by Age Group", x = NULL, y = NULL) +
    geom_text(aes(x = c(1.6, 1.2, 1.0, 1.0),
                  y = 1 - y_tick,
                  label = Percent),
              size = 5) +
    theme(panel.background = element_rect(fill = "white", color = "white"),
          plot.title = element_text(face = "bold", size = 16, hjust = 0.6,
                                    margin = margin(t = 10)),
          legend.title = element_text(face = "bold", colour = "black", size = 12),
          legend.text = element_text(size = 10, color = "black"),
          axis.text = element_blank(),
          axis.ticks = element_blank())
```
Add another pivot chart, this time for the pivot table that shows Revenue by
Frame size. Select a Bar chart to display the order of sales by Frame size.
Sort the Y axis to show the Frame size that has the most sales on the top. 
```{r}
ans_4 <- my_data %>%
    filter(!is.na(`Frame Size`)) %>%
    group_by(`Frame Size`) %>%
    summarise(`Total Revenue` = sum(Revenue)) %>%
    arrange(`Total Revenue`)

ans_4$`Frame Size` <- factor(ans_4$`Frame Size`, levels = ans_4$`Frame Size`)
```
## Question 4: In this chart, you can clearly see the order of sales by
## Frame size. Which frame size sold the least?
```{r}
ggplot(ans_4, aes(x = `Frame Size`, y = `Total Revenue`, fill = `Frame Size`)) +
    geom_bar(stat = "identity", show.legend = FALSE) +
    scale_x_discrete(expand = c(0, 0)) +
    scale_y_continuous(labels = scales::dollar, expand = c(0, 0),
                       limits = c(0, max(ans_4$`Total Revenue`)*1.05)) +
    coord_flip() +
    geom_text(aes(label = paste("$", prettyNum(`Total Revenue`, ","))),
              hjust = 1.1, colour = "black") +
    labs(title = "Sales by Frame Size") +
    theme(plot.title = element_text(face = "bold", hjust = 0.5),
          panel.border = element_rect(linetype = "solid", fill = NA, size = 1),
          axis.text = element_text(size = 10, colour = "black"),
          axis.title = element_text(size = 12, face = "bold"))
```