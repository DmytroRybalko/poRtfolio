---
title: "DAT205x: Introduction to Data Analysis using R. Lab3b"
output: html_notebook
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
    fig.width = 9,
    fig.height = 7)
```

# Scenario

Now you can start adding some charts.

Load libraries
```{r}
library(tidyverse)
library(scales)
library(RColorBrewer)
```
Load data for Lab3b
```{r}
my_data <- readRDS("./week2/data4week3.rds")
```
Add a chart that shows yearly **Sales by Country**. Select a line chart to display the yearly trend. Make sure that the Years are located in the X axis, the **Revenue** in the Y axis, and the **Countries** as categories.

In this chart, you can clearly see the sales trend for each **Country**.

---

#### **Question 1:** Which countryâ€™s trend is the most different when compared to the other countries?
```{r include = FALSE}
line_theme <- theme_classic() +
    theme(plot.title = element_text(face = "bold", hjust = 0.5),
          panel.grid.major = element_line(colour = "gray"),
          panel.grid.minor = element_line(colour = "gray", size = 0.1),
          legend.title = element_text(face = "bold", colour = "black", size = 12),
          legend.text = element_text(size = 11, color = "black"),
          axis.text = element_text(size = 11, colour = "black"),
          axis.title = element_text(size = 12, face = "bold"))
```

```{r}
my_data %>%
    group_by(Year, Country) %>%
    summarise(Total = sum(Revenue)) %>%
    ggplot(aes(x = Year, y = Total, color = reorder(Country, -Total))) +
    geom_line(size = 1.2) +
    geom_point(size = 2) +
    scale_y_continuous(breaks = seq(0, 6e6, by = 1e6), labels = scales::dollar,
                       limits = c(0, 6.5e6), expand = c(0, 0)) +
    labs(color = "Country", title = "Yearly Sales by Country") +
    line_theme
```

#### **Answer:** Australia

---

#### **Question 2:** Which year does the Bikes category have the least sales?  
```{r}
my_data %>%
    group_by(Year, `Product Category`) %>%
    summarise(Total = sum(Revenue)) %>%
    ggplot(aes(x = Year, y = Total, color = reorder(`Product Category`,- Total))) +
    geom_line(size = 1.2) +
    geom_point(size = 2) +
    scale_y_continuous(limits = c(0, 15e6),labels = scales::dollar, expand = c(0, 0)) +
    labs(color = " Product\nCategory", title = "Yearly Sales by Category") +
    line_theme
```
  
#### **Answer:** 2014

---

Add another pivot chart, this time for the pivot table that shows **Revenue** by **Age Group**. Select a pie chart to display the proportion of each **Age Group**. Add the labels to show percentage, formatted to two decimal points.  
```{r ans_3}
ans_3 <- my_data %>%
    group_by(`Age Group`) %>%
    summarise(Total = sum(Revenue)) %>%
    arrange(Total) %>%
    mutate(Prop = formatC(Total / sum(Total), digits = 4, format = "f") %>%
               as.numeric(),
           Percent = paste(Prop * 100, "%"),
           y_tick = cumsum(Prop) - Prop / 2)

ans_3$`Age Group` <- factor(ans_3$`Age Group`,
                                      levels = ans_3$`Age Group`)
```

In this chart, we can clearly see the proportion of sales for each **Age Group**.

---  

#### **Question 3:** What is the proportion of sales for Young Adults?
```{r}
ggplot(ans_3, aes(x = "", y = Prop, fill = `Age Group`)) +
    geom_bar(width = 1, stat = "identity", colour = "white", size = 0.7) +
    coord_polar(theta = "y") +
    labs(title = "Sales by Age Group", x = NULL, y = NULL) +
    geom_text(aes(x = c(1.6, 1.2, 1.1, 1.1), y = 1 - y_tick, label = Percent), size = 7) +
    theme(panel.background = element_rect(fill = "white", color = "white"),
          plot.title = element_text(face = "bold", size = 15, hjust = 0.5),
          legend.title = element_blank(),
          legend.text = element_text(size = 10, color = "black"),
          axis.text = element_blank(),
          axis.ticks = element_blank()) +
    scale_fill_brewer(palette = "Set1")
```

#### **Answer:** `r ans_3[ans_3$'Age Group' == "Young Adults", ]$Percent`

---

Add another pivot chart, this time for the pivot table that shows **Revenue** by **Frame size**. Select a bar chart to display the order of sales by **Frame size**. Sort the Y axis to show the **Frame size** that has the most sales on the top.  
```{r ans_4}
ans_4 <- my_data %>%
    filter(!is.na(`Frame Size`)) %>%
    group_by(`Frame Size`) %>%
    summarise(`Total Revenue` = sum(Revenue)) %>%
    arrange(`Total Revenue`)
```

---

#### **Question 4:** In this chart, you can clearly see the order of sales by Frame size. Which frame size sold the least?
```{r}
ggplot(ans_4, aes(x = reorder(`Frame Size`, `Total Revenue`), y = `Total Revenue`)) +
    geom_bar(stat = "identity", width = 0.7, show.legend = FALSE, fill = "tomato2") +
    scale_y_continuous(labels = scales::dollar, expand = c(0.01, 0),
                       limits = c(0, max(ans_4$`Total Revenue`)*1.05)) +
    coord_flip() +
    geom_text(aes(label = paste("$", prettyNum(`Total Revenue`, ","))),
              hjust = 1.1, colour = "black") +
    labs(x = "Frame Size", y = "Total Revenue", title = "Sales by Frame Size") +
    theme_classic() +
    theme(plot.title = element_text(face = "bold", hjust = 0.5),
          axis.text = element_text(size = 11, colour = "black"),
          axis.title = element_text(size = 12, face = "bold"))
```

#### **Answer:** 54