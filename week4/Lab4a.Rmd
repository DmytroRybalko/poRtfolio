---
title: "DAT205x: Introduction to Data Analysis using R. Lab4a"
output: html_notebook
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
    fig.width = 9,
    fig.height = 7)
#  hide output
```

# Scenario

You have created several pivot tables and pivot charts for Lucy.

You can download the latest report here: week2/data4week3.rds
```{r}
my_data <- readRDS("./week2/data4week3.rds")
```
Load libraries
```{r results='hide'}
library(tidyverse)
library(scales)
library(RColorBrewer)
```

So far everything has been well received by her. However, she would like to have easier ways to slice and dice the reports and charts herself. You sat down with Lucy, and come up with several different ways that Lucy could slice the data

* Year
* Country
* Customer Gender  
* Age Group
* Product Category
* Sub Category
* Frame size

In this Lab we continue to work with data from Lab3b and with the same type of charts but will use other data subsets.

Set common theme for line charts
```{r line_theme}
line_theme <- theme_classic() +
    theme(plot.title = element_text(face = "bold", hjust = 0.5),
          panel.grid.major = element_line(colour = "gray"),
          panel.grid.minor = element_line(colour = "gray", size = 0.1),
          legend.title = element_text(face = "bold", colour = "black", size = 12),
          legend.text = element_text(size = 10, color = "black"),
          axis.text = element_text(size = 10, colour = "black"))
```
Set common theme for pie charts
```{r pie_theme}
pie_theme <- theme(panel.background = element_rect(fill = "white", color = "white"),
          plot.title = element_text(face = "bold", size = 15, hjust = 0.5),
          legend.title = element_blank(),
          #legend.title = element_text(face = "bold", colour = "black", size = 12),
          legend.text = element_text(size = 10, color = "black"),
          axis.text = element_blank(),
          axis.ticks = element_blank())
```

---

#### **Question 1:** A quick glance on the Yearly Sales by Country shows that Australia has an unusual trend compared to the other countries. Which year does Australia have the least sales?
```{r}
my_data %>%
    group_by(Year, Country) %>%
    summarise(Total = sum(Revenue)) %>%
    ggplot(aes(x = Year, y = Total, color = reorder(Country, -Total))) +
    geom_line(size = 1.2) +
    geom_point(size = 2) +
    scale_y_continuous(breaks = seq(1e6, 6e6, by = 1e6), labels = scales::dollar) +
    labs(x = NULL, y = NULL, color = "Country", title = "Yearly Sales by Country") +
    scale_colour_brewer(palette = "Dark2") +
    line_theme
```

#### **Answer:** 2011

---

Create an additional pivot chart to show **Sales by Country** using pie chart. Show percentages for each slice of the pie. Overall, **Australia** commands 25% of the company's total sales. But in some of the years, this proportion changes.

#### **Question 2:** What is the percentage of Australia sales (of total sales) in the year that it has the least sales (previous question)?
```{r ans_2}
ans_2 <- my_data %>%
    filter(Year == "2011") %>%
    group_by(Country) %>%
    summarise(Total = sum(Revenue)) %>%
    arrange(desc(Total)) %>%
    mutate(Prop = formatC(Total / sum(Total), digits = 3, format = "f") %>%
               as.numeric(),
           Percent = paste(Prop * 100, "%"),
           y_tick = cumsum(Prop) - Prop / 2)
```

```{r}
ggplot(ans_2, aes(x = "", y = Prop, fill = reorder(Country, -Prop))) +
    geom_bar(width = 1, stat = "identity", colour = "white", size = 0.7) +
    coord_polar(theta = "y") +
    labs(title = "Sales by Country", x = NULL, y = NULL, fill = "Country") +
    geom_text(aes(x = c(1.0, 1.1, 1.2, 1.25, 1.25, 1.3), y = 1 - y_tick, label = Percent), size = 5) +
    scale_fill_brewer(palette = "Dark2") +
    pie_theme
```

#### **Answer:** `r ans_2[ans_2$Country == "Australia", ]$Percent`

---

#### **Question 3:** Let's filter the charts by Australia. What might be the cause of this trend? 
```{r ans_3}
ans_3 <- my_data %>%
    filter(Country == "Australia", Year > 2012) %>%
    group_by(Year, `Product Category`) %>%
    summarise(Total = sum(Revenue))
```

```{r}
ggplot(ans_3, aes(x = Year, y = Total, color = reorder(`Product Category`, - Total))) +
    geom_line(size = 1.2) +
    geom_point(size = 2) +
    scale_y_continuous(labels = scales::dollar) +
    labs(x = NULL, y = NULL, color = " Product\nCategory", title = "Australia Sales by Category") +
    scale_colour_brewer(palette = "Set2") +
    line_theme
```

#### **Answer:** the sharp fluctuations of bicycle sales

---

#### **Question 4:** For all the years that has all the three categories, which year does the Bikes has the least proportion?

#### **Answer:** 2014

---

Based on your hypothesis (previous question), create an additional pivot chart to show **Sales by Category** using Pie chart. Show percentages for each slice of the pie chart. Filter the charts by **Australia** and play around with the **Year** filter. Notice for different years, the changes in composition of **Australia** sales by **Category**.

#### **Question 5:** What is the percentage of Bikes sales (of total sales) in that year?
```{r ans_5}
ans_5 <- my_data %>%
    filter(Country == "Australia", Year == 2014) %>%
    group_by(`Product Category`) %>%
    summarise(Total = sum(Revenue)) %>%
    mutate(Prop = formatC(Total / sum(Total), digits = 2, format = "f") %>%
               as.numeric(),
           Percent = paste(Prop * 100, "%"),
           y_tick = cumsum(Prop) - Prop / 2)
```

```{r}
ggplot(ans_5, aes(x = "", y = Prop, fill = `Product Category`)) +
    geom_bar(width = 1, stat = "identity", colour = "white", size = 0.7) +
    coord_polar(theta = "y") +
    labs(title = paste("Proportion by Product Category for Australia in", 2014), x = NULL, y = NULL) +
    geom_text(aes(x = c(1.2, 1.2, 1.3), y = 1 - y_tick, label = Percent), size = 9) +
    scale_fill_brewer(palette = "Set2") +
    pie_theme
```

#### **Answer:** `r ans_5[ans_5$'Product Category' == "Bikes", ]$Percent`