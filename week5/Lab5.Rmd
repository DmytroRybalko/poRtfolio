---
title: "DAT205x: Introduction to Data Analysis using R. Lab5"
output: html_notebook
---

## Scenario  

Lucy was impressed with the dashboard you created. With the dashboard, she is able to narrow down her interest. Specifically, she is interested with the sales in Australia. She would like to perform simple profitability analysis on the product category and sub-category, for specific year. Furthermore, she wants to have the option of going deeper to product level.

```{r setup, include = FALSE}
knitr::opts_chunk$set(
    fig.width = 9,
    fig.height = 7)
# hide output
```
Load libraries
```{r results='hide'}
library(tidyverse)
library(scales)
```
Load data for Lab5b
```{r}
my_data <- readRDS("./week2/data4week3.rds")
```

---

Let's start! Filter the pivot table for **Australia** and **2016**, and answer the following questions.

#### **Question 1:** Which Sub Category sold the most quantity?
```{r ans_1}
ans_1 <- my_data %>%
    filter(Country == "Australia", Year == 2016) %>%
    group_by(`Sub Category`) %>%
    summarise(Quantity = sum(`Order Quantity`)) %>% 
    arrange(desc(Quantity))
```
Set common theme:
```{r}
common_theme <- theme_classic() +
    theme(axis.text.x = element_text(angle = 65, vjust = 1.0, hjust = 1.0),
          axis.text = element_text(size = 11, colour = "black"),
          axis.title = element_text(size = 12, face = "bold"))
```
#### **Answer:**
```{r}
ggplot(ans_1, aes(x = reorder(`Sub Category`, -Quantity), y = Quantity)) +
    geom_bar(stat = "identity", width = 0.5, fill="tomato2") +
    labs(x = "Sub Category") +
    scale_y_log10(breaks = c(10^(0:5), 3e4), expand = c(0.01, 0.01)) +
    common_theme
```

---

#### **Question 2:** Which Sub Category has the most revenue?
```{r}
ans_2 <- my_data %>%
    filter(Country == "Australia", Year == 2016) %>%
    group_by(`Sub Category`) %>%
    summarise(`Total Revenue` = sum(Revenue))
```
#### **Answer:**
```{r}
ggplot(ans_2, aes(x = reorder(`Sub Category`, -`Total Revenue`), y = `Total Revenue`)) +
    geom_bar(stat = "identity", width = 0.5, fill="tomato2") +
    labs(x = "Sub Category") +
    scale_y_log10(breaks = 10^(1:6), labels = scales::dollar, expand = c(0.01, 0)) +
    common_theme
```

---

Now add a calculated field Margin with the value derived from the Profit and Revenue column. Format the field as percentage with two decimal places. HINT: Margin = Profit / Revenue

#### **Question 3:** What is the total margin for Australia in the year 2016?   
```{r}
ans_3 <- my_data %>% 
    filter(Year == 2016) %>% 
    group_by(Country) %>% 
    summarise(`Margin` = sum(Profit) / sum(Revenue))
```
   
#### **Answer:**   
```{r}
ggplot(ans_3, aes(x = reorder(Country, -Margin), y = Margin, fill = Country)) +
    geom_bar(stat = "identity", width = 0.5, show.legend = FALSE) +
    labs(x = "Country") +
    scale_y_continuous(breaks = seq(0, .6, by = .1), expand = c(0.02, 0.0),
                       limits = c(0, .6), labels = scales::percent) +
    geom_text(aes(label = paste(formatC(`Margin` * 100, digits = 1, format = "f"), "%")),
              vjust = -0.5, colour = "black", fontface = "bold", size = 5) +
    theme_classic() +
    theme(axis.title = element_text(size = 12, face = "bold"),
          axis.text = element_text(size = 11, colour = "black"),
          axis.line.x = )
```

---

#### **Question 4:** Using the same filters, which Category has the lowest Margin?
```{r}
ans_4 <- my_data %>%
    filter(Country == "Australia", Year == 2016) %>%
    group_by(`Product Category`) %>%
    summarise(`Margin` = sum(Profit) / sum(Revenue))
```
#### **Answer:**
```{r}
ggplot(ans_4, aes(x = reorder(`Product Category`, -`Margin`),
                  y = `Margin`, fill = `Product Category`)) +
    geom_bar(stat = "identity", width = 0.5, show.legend = FALSE) +
    labs(x = "Product Category") +
    scale_y_continuous(breaks = seq(0, .6, by = .1), expand = c(0.02, 0.0),
                       limits = c(0, .6), labels = scales::percent) +
    geom_text(aes(label = paste(formatC(`Margin` * 100, digits = 2, format = "f"), "%")),
              vjust = -0.5, colour = "black", fontface = "bold", size = 5) +
    theme_classic() +
    theme(axis.title = element_text(size = 12, face = "bold"),
          axis.text = element_text(size = 11, colour = "black"))
```

---

#### **Question 5:** Which Sub Category has the lowest margin?
```{r}
ans_5 <- my_data %>%
    filter(Country == "Australia", Year == 2016) %>%
    group_by(`Sub Category`) %>%
    summarise(`Margin` = sum(Profit) / sum(Revenue))
```
#### **Answer:**
```{r}
ggplot(ans_5, aes(x = reorder(`Sub Category`, -`Margin`),
                  y = `Margin`, fill = `Sub Category`)) +
    geom_bar(stat = "identity", width = 0.5, fill = "tomato2") +
    labs(x = "Sub Category") +
    scale_y_continuous(breaks = seq(0, .6, by = .1), expand = c(0.01, 0.0),
                       labels = scales::percent) +
    common_theme
#TODO: make strip palette with two colours
```

---

#### **Question 6:** Which Product has the least margin?
```{r ans_6, results = "hide"}
ans_6 <- my_data %>%
    filter(Country == "Australia", Year == 2016) %>%
    group_by(Product, `Sub Category`, `Product Category`) %>%
    summarise(Margin = formatC(sum(Profit) / sum(Revenue), digits = 2, format = "f") %>% 
                  as.numeric()) %>%
    ungroup() %>% 
    arrange(Margin) %>% 
    top_n(-10)
```
#### **Answer:**
```{r}
ggplot(ans_6, aes(y = reorder(Product, -`Margin`), x = Margin), fill = Product) +
    geom_segment(aes(yend = Product), xend = 0, colour = "grey50") +
    geom_point(size = 8, color = "tomato2") +
    labs(y = "Product Item") +
    scale_x_continuous(breaks = seq(0, .21, by = .05), labels = scales::percent,
                       limits = c(0, .22), expand = c(0, 0), position = "top") +
    theme_classic() +
    theme(axis.text = element_text(size = 11, colour = "black"),
          axis.title = element_text(size = 12, face = "bold"))
```