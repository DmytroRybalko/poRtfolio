---
title: "DAT205x: Introduction to Data Analysis using R. Lab7"
output: html_notebook
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
    fig.width = 9,
    fig.height = 7)
```

## Scenario

Upon reviewing the growth report you created, Lucy asked for a report that shows composition of Product Categories and Sub Categories based on certain filters, including Year, Country, Customer Gender, and Age Group.

Specifically, Lucy wants to see the report visualized using a hierarchical chart.

Load necessary libraries
```{r results = "hide"}
library(tidyverse)
library(treemapify)
library(RColorBrewer)
library(knitr)
```
Load data for Lab7
```{r}
my_data <- readRDS("./week2/data4week3.rds")
```

---

#### **Question 1:** Explore the sales composition of Bikes category for each Age Group. Which Age Group does the composition (rank of sales) differ than the rest?

```{r}
ans_1 <- my_data %>%
    filter(`Product Category` == "Bikes") %>%
    group_by(`Age Group`, `Sub Category`) %>%
    summarise(Total = sum(Revenue)) %>%
    arrange(desc(Total)) %>% 
    ungroup() 
```
```{r}
ggplot(ans_1, aes(area = Total, fill = `Sub Category`, group = `Age Group`, label = `Age Group` )) +
    geom_treemap(colour = "white", size = 2) +
    geom_treemap_text(colour = "black", place = "centre", grow = T, min.size = 3) +
    scale_fill_brewer(palette = "Set2", labels = paste(ans_1$`Sub Category`, '\t')) +
    theme(legend.position = "top",
          legend.title = element_blank(),
          legend.text = element_text(size = 14, face = "bold"))
# TODO: add sunburst or mosaic chart
```

#### **Answer:** `r top_n(ans_1, -1)$'Age Group'` (right upper corner)

---

Now explore the sales composition of Bikes category for each Age Group for the Male customers.
```{r}
ans_2 <- my_data %>%
    filter(`Product Category` == "Bikes", `Customer Gender` == "M") %>%
    group_by(`Age Group`, `Sub Category`) %>%
    summarise(Total = sum(Revenue)) %>%
    arrange(desc(Total)) %>% 
    ungroup()
```

---

#### **Question 2:** Now explore the sales composition of Bikes category for each Age Group, for the Male customers. Which Age Group does the composition differ than the rest?
```{r}
ggplot(ans_2, aes(area = Total, fill = `Sub Category`, group = `Sub Category`, label = `Age Group` )) +
    geom_treemap(colour = "white", size = 2) +
    geom_treemap_text(colour = "black", place = "centre", grow = T, min.size = 3) +
    scale_fill_brewer(palette = "Set2", labels = paste(ans_2$`Sub Category`, '\t')) +
    theme(legend.position = "top",
          legend.title = element_blank(),
          legend.text = element_text(size = 14, face = "bold"))
# TODO: add sunburst or mosaic chart
```

#### **Answer 2:** The composition are the same across Age Group for Male customers.

---

#### **Question 3:** Clear all filters. Now, filter for the year 2016 and Germany. Rank the sales from the highest to lowest for the Clothing category
```{r}
ans_3 <- my_data %>%
    filter(Year == 2016, Country == "Germany", `Product Category` == "Clothing") %>%
    group_by(`Sub Category`) %>%
    summarise(Total = sum(Revenue)) %>%
    arrange(desc(Total)) %>% 
    ungroup()
```

#### **Answer:**
```{r}
ggplot(ans_3, aes(x = reorder(`Sub Category`, -Total), y = Total, fill = `Sub Category`)) +
    geom_bar(stat = "identity", width = 0.5, show.legend = FALSE) +
    labs(x = "Sub Category") +
    scale_y_log10(breaks = c(1, 1e2, 1e3, 1e4, 2e4, 1e5),
                  expand = c(0.02, 0.0), labels = scales::dollar) +
    theme_classic() +
    theme(axis.title = element_text(size = 12, face = "bold"),
          axis.text = element_text(size = 11, colour = "black"))
```

---

#### **Question 4:** Rank the sales from the highest to lowest for the Clothing category. Keep the filter settings and add filter by Male customers.

```{r}
ans_4 <- my_data %>%
    filter(Year == 2016, Country == "Germany",
           `Product Category` == "Clothing", `Customer Gender` == "M") %>%
    group_by(`Sub Category`) %>%
    summarise(Total = sum(Revenue)) %>%
    arrange(desc(Total)) %>% 
    ungroup()
```

#### **Answer:**

```{r}
ggplot(ans_4, aes(x = reorder(`Sub Category`, -Total), y = Total, fill = `Sub Category`)) +
    geom_bar(stat = "identity", width = 0.5, show.legend = FALSE) +
    labs(x = "Sub Category") +
    scale_y_log10(breaks = c(1, 10, 100, 1e3, 5e3, 15e3, 5e4),
                  expand = c(0.02, 0.0), labels = scales::dollar) +
    theme_classic() +
    theme(axis.title = element_text(size = 12, face = "bold"),
          axis.text = element_text(size = 11, colour = "black"))
```

---

#### **Question 5:** Rank the sales from the highest to lowest for the Clothing category. Keep the filter settings and add filter by Youth Age Group.

```{r}
ans_5 <- my_data %>%
    filter(Year == 2016, Country == "Germany", `Product Category` == "Clothing",
           `Customer Gender` == "M", `Age Group` == "Youth") %>%
    group_by(`Sub Category`) %>%
    summarise(Total = sum(Revenue)) %>%
    arrange(desc(Total)) %>% 
    ungroup()
```

#### **Answer:**

```{r}
ggplot(ans_5, aes(x = reorder(`Sub Category`, -Total), y = Total, fill = `Sub Category`)) +
    geom_bar(stat = "identity", width = 0.5, show.legend = FALSE) +
    labs(x = "Sub Category") +
    scale_y_log10(breaks = c(1, 10, 100, 1000, 5000),
                  expand = c(0.02, 0.0), labels = scales::dollar) +
    theme_classic() +
    theme(axis.title = element_text(size = 12, face = "bold"),
          axis.text = element_text(size = 11, colour = "black")
          )
```